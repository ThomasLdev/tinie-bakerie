name: CI

on:
  push:
    branches:
      - main
  pull_request: ~
  workflow_dispatch: ~

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  static_analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker images
        uses: docker/bake-action@v5
        with:
          pull: true
          load: true
          files: |
            compose.yaml
            compose.override.yaml
          set: |
            *.cache-from=type=gha,scope=${{github.ref}}
            *.cache-from=type=gha,scope=refs/heads/main
            *.cache-to=type=gha,scope=${{github.ref}},mode=max
      - name: Start services (including Node.js for linting)
        run: docker compose --profile dev up --wait --no-build
      - name: Check HTTP reachability
        run: |
          echo "Waiting for HTTP server to be ready..."
          for i in {1..30}; do
            if curl -f --silent --max-time 5 -H "Host: php" http://localhost > /dev/null 2>&1; then
              echo "✓ HTTP server is ready"
              curl -v --fail-with-body -H "Host: php" http://localhost
              exit 0
            fi
            echo "Waiting for server... (attempt $i/30)"
            sleep 2
          done
          echo "✗ HTTP server failed to become ready"
          curl -v --fail-with-body -H "Host: php" http://localhost || exit 1
      - name: Check HTTPS reachability
        run: |
          echo "Waiting for HTTPS server to be ready..."
          for i in {1..30}; do
            if curl -fk --silent --max-time 5 --resolve local.tinie-bakerie.com:443:127.0.0.1 https://local.tinie-bakerie.com > /dev/null 2>&1; then
              echo "✓ HTTPS server is ready"
              curl -vk --fail-with-body --resolve local.tinie-bakerie.com:443:127.0.0.1 https://local.tinie-bakerie.com
              exit 0
            fi
            echo "Waiting for server... (attempt $i/30)"
            sleep 2
          done
          echo "✗ HTTPS server failed to become ready"
          curl -vk --fail-with-body --resolve local.tinie-bakerie.com:443:127.0.0.1 https://local.tinie-bakerie.com || exit 1
      - name: Run PHPStan
        run: make phpstan
      - name: Run PHPMD
        run: make phpmd
      - name: Run PHP CS Fixer
        run: make phpcs-dry
      - name: Run Twig CS
        run: make twig-linter
      - name: Install Node.js dependencies
        run: make node-install
      - name: Run ESLint (TypeScript)
        run: make lint
      - name: Check TypeScript formatting
        run: make format-check
      - name: TypeScript type checking
        run: make type-check
      - name: Run PHPUnit Unit Suite
        run: make unit
  functional_test:
    name: Functional Tests
    runs-on: ubuntu-latest
    needs: static_analysis
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker images
        uses: docker/bake-action@v5
        with:
          pull: true
          load: true
          files: |
            compose.yaml
            compose.override.yaml
          set: |
            *.cache-from=type=gha,scope=${{github.ref}}
            *.cache-from=type=gha,scope=refs/heads/main
            *.cache-to=type=gha,scope=${{github.ref}},mode=max
      - name: Start services (production mode - no Node.js needed for PHP tests)
        run: docker compose up --wait --no-build
      - name: Create Test Database
        run: make doctrine-db-test-create
      - name: Run Migrations
        run: make doctrine-migrate-test
      - name: Run Fixtures
        run: make fixtures-test
      - name: Doctrine Schema Validator
        run: make doctrine-validate-schema
      - name: Run PHPUnit Functional Suite
        run: make functional
  e2e_tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: static_analysis
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker images
        uses: docker/bake-action@v5
        with:
          pull: true
          load: true
          files: |
            compose.yaml
            compose.override.yaml
          set: |
            *.cache-from=type=gha,scope=${{github.ref}}
            *.cache-from=type=gha,scope=refs/heads/main
            *.cache-to=type=gha,scope=${{github.ref}},mode=max
      - name: Start services (including Node.js for E2E)
        run: docker compose --profile dev up --wait --no-build
      - name: Create Test Database
        run: make doctrine-db-test-create
      - name: Run Migrations
        run: make doctrine-migrate-test
      - name: Run Fixtures
        run: make fixtures-test
      - name: Install Node.js dependencies
        run: make node-install
      - name: Install Playwright Dependencies
        run: make e2e-install
      - name: Run E2E Tests
        run: make e2e
        env:
          CI: true
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results/
          retention-days: 30
  lint:
    name: Docker Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
